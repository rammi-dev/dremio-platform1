#
# Copyright (C) 2017-2019 Dremio Corporation. This file is confidential and private property.
#

suite: Dremio EE Helm Chart.OpenSearch Operator Service Account Tests
templates:
  - opensearch-operator-service-account.yaml
set:
  distStorage:
    type: gcp
    gcp:
      bucketName: test-bucket
      authentication: auto
      credentials:
        clientEmail: test@example.com
        privateKey: test-private-key
tests:
  - it: should not include imagePullSecrets by default
    asserts:
      - notExists:
          path: imagePullSecrets
  - it: should include imagePullSecrets
    set:
      imagePullSecrets:
        - test-0
        - test-1
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: test-0
      - equal:
          path: imagePullSecrets[1].name
          value: test-1
  - it: should include trial secret name in pull secrets if dremio.trialImagePullCredentials is set
    set:
      dremio.trialImagePullCredentials: test-credentials
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: dremio-trial-image-pull-credentials
  - it: should include imagePullSecrets in addition to the trial secret name in pull secrets
    set:
      imagePullSecrets:
        - test-0
        - test-1
      dremio.trialImagePullCredentials: test-credentials
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: test-0
      - equal:
          path: imagePullSecrets[1].name
          value: test-1
      - equal:
          path: imagePullSecrets[2].name
          value: dremio-trial-image-pull-credentials
  - it: should not include annotations by default
    asserts:
      - notExists:
          path: metadata.annotations
  - it: should include serviceAccount.annotations when configured
    set:
      opensearchOperator:
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
            example.com/custom-annotation: "custom-value"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"
      - equal:
          path: metadata.annotations["example.com/custom-annotation"]
          value: "custom-value"
  - it: should include single serviceAccount.annotation when configured
    set:
      opensearchOperator:
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"
  - it: should not include annotations when serviceAccount.annotations is empty
    set:
      opensearchOperator:
        serviceAccount:
          annotations: {}
    asserts:
      - notExists:
          path: metadata.annotations
  - it: should use correct service account name
    asserts:
      - equal:
          path: metadata.name
          value: dremio-opensearch-operator
  - it: should use custom service account name when configured
    set:
      opensearchOperator:
        serviceAccount:
          name: custom-opensearch-operator
    asserts:
      - equal:
          path: metadata.name
          value: custom-opensearch-operator
