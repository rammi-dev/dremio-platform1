#
# Copyright (C) 2017-2019 Dremio Corporation. This file is confidential and private property.
#

suite: Dremio EE Helm Chart.Engine Executor Service Account Tests
templates:
  - dremio-engine-operator.yaml
set:
  distStorage:
    type: gcp
    gcp:
      bucketName: test-bucket
      authentication: auto
      credentials:
        clientEmail: test@example.com
        privateKey: test-private-key
tests:
  - it: should not include annotations by default
    documentIndex: 6
    asserts:
      - notExists:
          path: metadata.annotations
  - it: should include serviceAccountAnnotations when configured
    documentIndex: 6
    set:
      engine:
        executor:
          serviceAccountAnnotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
            example.com/custom-annotation: "custom-value"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"
      - equal:
          path: metadata.annotations["example.com/custom-annotation"]
          value: "custom-value"
  - it: should include single serviceAccountAnnotation when configured
    documentIndex: 6
    set:
      engine:
        executor:
          serviceAccountAnnotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"
  - it: should not include annotations when serviceAccountAnnotations is empty
    documentIndex: 6
    set:
      engine:
        executor:
          serviceAccountAnnotations: {}
    asserts:
      - notExists:
          path: metadata.annotations
  - it: should use correct service account name
    documentIndex: 6
    asserts:
      - equal:
          path: metadata.name
          value: dremio-engine-executor
  - it: should use custom service account name when configured
    documentIndex: 6
    set:
      engine:
        executor:
          serviceAccount: custom-engine-executor
    asserts:
      - equal:
          path: metadata.name
          value: custom-engine-executor
  - it: should have correct labels
    documentIndex: 6
    asserts:
      - equal:
          path: metadata.labels.app
          value: engine-executor
  - it: should be a ServiceAccount
    documentIndex: 6
    asserts:
      - isKind:
          of: ServiceAccount
