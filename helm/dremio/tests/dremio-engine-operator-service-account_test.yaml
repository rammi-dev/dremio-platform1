#
# Copyright (C) 2017-2019 Dremio Corporation. This file is confidential and private property.
#

suite: Dremio EE Helm Chart.Engine Operator Service Account Tests
templates:
  - dremio-engine-operator.yaml
set:
  distStorage:
    type: gcp
    gcp:
      bucketName: test-bucket
      authentication: auto
      credentials:
        clientEmail: test@example.com
        privateKey: test-private-key
tests:
  - it: should not include imagePullSecrets by default
    documentIndex: 0
    asserts:
      - notExists:
          path: imagePullSecrets
  - it: should include imagePullSecrets
    documentIndex: 0
    set:
      imagePullSecrets:
        - test-0
        - test-1
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: test-0
      - equal:
          path: imagePullSecrets[1].name
          value: test-1
  - it: should include trial secret name in pull secrets if dremio.trialImagePullCredentials is set
    documentIndex: 0
    set:
      dremio.trialImagePullCredentials: test-credentials
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: dremio-trial-image-pull-credentials
  - it: should include imagePullSecrets in addition to the trial secret name in pull secrets
    documentIndex: 0
    set:
      imagePullSecrets:
        - test-0
        - test-1
      dremio.trialImagePullCredentials: test-credentials
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: test-0
      - equal:
          path: imagePullSecrets[1].name
          value: test-1
      - equal:
          path: imagePullSecrets[2].name
          value: dremio-trial-image-pull-credentials
  - it: should not include annotations by default
    documentIndex: 0
    asserts:
      - notExists:
          path: metadata.annotations
  - it: should include serviceAccountAnnotations when configured
    documentIndex: 0
    set:
      engine:
        operator:
          serviceAccountAnnotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
            example.com/custom-annotation: "custom-value"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"
      - equal:
          path: metadata.annotations["example.com/custom-annotation"]
          value: "custom-value"
  - it: should include single serviceAccountAnnotation when configured
    documentIndex: 0
    set:
      engine:
        operator:
          serviceAccountAnnotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"
  - it: should not include annotations when serviceAccountAnnotations is empty
    documentIndex: 0
    set:
      engine:
        operator:
          serviceAccountAnnotations: {}
    asserts:
      - notExists:
          path: metadata.annotations
  - it: should use correct service account name
    documentIndex: 0
    asserts:
      - equal:
          path: metadata.name
          value: dremio-engine-operator
  - it: should use custom service account name when configured
    documentIndex: 0
    set:
      engine:
        operator:
          serviceAccount: custom-engine-operator
    asserts:
      - equal:
          path: metadata.name
          value: custom-engine-operator
  - it: should have correct labels
    documentIndex: 0
    asserts:
      - equal:
          path: metadata.labels.app
          value: engine-operator
  - it: should be a ServiceAccount
    documentIndex: 0
    asserts:
      - isKind:
          of: ServiceAccount
