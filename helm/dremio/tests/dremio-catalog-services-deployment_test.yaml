#
# Copyright (C) 2017-2019 Dremio Corporation. This file is confidential and private property.
#

suite: Dremio EE Helm Chart.Catalog Services Tests
release:
  name: my-release
  namespace: my-namespace
templates:
  - dremio-catalog-services-deployment.yaml
set:
  distStorage:
    type: gcp
    gcp:
      bucketName: test-bucket
      authentication: auto
      credentials:
        clientEmail: test@example.com
        privateKey: test-private-key
tests:
  - it: catalogservices.podAnnotations should append pod annotations
    set:
      podAnnotations:
        root: test
      mongodb:
        backup:
          enabled: false
      catalogservices:
        podAnnotations:
          catalogservices: test
    asserts:
      - equal:
          path: spec.template.metadata.annotations.catalogservices
          value: test
  - it: pod annotations should apply when set at root level
    set:
      podAnnotations:
        root: test
      mongodb:
        backup:
          enabled: false
    asserts:
      - equal:
          path: spec.template.metadata.annotations.root
          value: test
  - it: should not include nodeSelectors by default
    asserts:
      - notExists:
          path: spec.template.spec.nodeSelector
  - it: catalogservices.nodeSelector should take priority over nodeSelector
    set:
      catalogservices:
        nodeSelector:
          catalogservicesSelector: catalogservicesSelector
      mongodb:
        backup:
          enabled: false
      nodeSelector:
        testSelector: testSelector
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
           catalogservicesSelector: catalogservicesSelector
  - it: nodeSelector should apply when set at root level
    set:
      nodeSelector:
        testSelector: testSelector
      mongodb:
        backup:
          enabled: false
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            testSelector: testSelector
  - it: catalogservices.tolerations should apply tolerations
    set:
      tolerations: [{key: "root", operator: "Equal", value: "value1", effect: "NoSchedule" }]
      mongodb:
        backup:
          enabled: false
      catalogservices:
        tolerations: [{key: "catalogservices", operator: "Equal", value: "value1", effect: "NoSchedule" }]
    asserts:
      - equal:
          path: spec.template.spec.tolerations
          value: [{key: "catalogservices", operator: "Equal", value: "value1", effect: "NoSchedule" }]
  - it: tolerations should be applied when set at root level
    set:
      tolerations: [{key: "root", operator: "Equal", value: "value1", effect: "NoSchedule" }]
      mongodb:
        backup:
          enabled: false
    asserts:
      - equal:
          path: spec.template.spec.tolerations
          value: [{key: "root", operator: "Equal", value: "value1", effect: "NoSchedule" }]
  - it: metadata.annotations should be empty by default
    asserts:
      - notExists:
          path: metadata.annotations
  - it: catalogservices.annotations should set metadata.annotations
    set:
      annotations:
        rootAnnotation: test
      mongodb:
        backup:
          enabled: false
      catalogservices:
        annotations:
          catalogservicesAnnotation: test
    asserts:
      - equal:
          path: metadata.annotations
          value:
            catalogservicesAnnotation: test
  - it: metadata.annotations should be apply when set at root level
    set:
      annotations:
        rootAnnotation: test
      mongodb:
        backup:
          enabled: false
    asserts:
      - equal:
          path: metadata.annotations
          value:
            rootAnnotation: test
  - it: catalogservices.podLabels should apply podLabels
    set:
      podLabels:
        root: test
      mongodb:
        backup:
          enabled: false
      catalogservices:
        podLabels:
          catalogservices: test
    asserts:
      - equal:
          path: spec.template.metadata.labels.catalogservices
          value: test
  - it: podLabels should be applied when set at root level
    set:
      podLabels:
        root: test
      mongodb:
        backup:
          enabled: false
    asserts:
      - equal:
          path: spec.template.metadata.labels.root
          value: test
  # Tests for copy run scripts init container helper
  - it: should include copy run scripts init container with default catalog image values
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: copy-run-scripts
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: quay.io/dremio/dremio-catalog-server:26.1.1
      - equal:
          path: spec.template.spec.initContainers[0].imagePullPolicy
          value: IfNotPresent
      - equal:
          path: spec.template.spec.initContainers[0].command
          value: ["sh", "-c", "cp /opt/jboss/container/java/run/* /mnt/rundir"]
      - equal:
          path: spec.template.spec.initContainers[0].resources.limits.cpu
          value: 100m
      - equal:
          path: spec.template.spec.initContainers[0].resources.limits.memory
          value: 200Mi
      - equal:
          path: spec.template.spec.initContainers[0].resources.requests.cpu
          value: 100m
      - equal:
          path: spec.template.spec.initContainers[0].resources.requests.memory
          value: 200Mi
      - contains:
          path: spec.template.spec.initContainers[0].volumeMounts
          content:
            name: run-scripts
            mountPath: /mnt/rundir
  - it: should use custom catalog image configuration for copy run scripts init container
    set:
      catalog:
        image:
          repository: custom-catalog-repo
          tag: custom-tag
          pullPolicy: Always
      mongodb:
        backup:
          enabled: false
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: copy-run-scripts
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: custom-catalog-repo:custom-tag
      - equal:
          path: spec.template.spec.initContainers[0].imagePullPolicy
          value: Always
  - it: should include default security context for copy run scripts init container
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsUser
          value: 10000
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsGroup
          value: 10001
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.privileged
          value: false
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.capabilities.drop[0]
          value: ALL

  - it: should include extra volumes and volume mounts
    set:
      catalogservices:
        extraVolumes:
          - name: extra-volume
            emptyDir: {}
        extraVolumeMounts:
          - name: extra-volume
            mountPath: /extra
            readOnly: false
      mongodb:
        backup:
          enabled: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-volume
            mountPath: /extra
            readOnly: false
      - contains:
          path: spec.template.spec.volumes
          content:
            name: extra-volume
            emptyDir: {}
  - it: should include extra env vars
    set:
      catalogservices:
        extraEnvs:
          - name: foo
            value: bar
      mongodb:
        backup:
          enabled: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: foo
            value: bar

  - it: should include extra init containers from catalog level
    set:
      catalogservices:
        extraInitContainers:
          - name: extra-init-container
            image: extra-init-container-image
            command: ["sh", "-c", "echo 'Hello {{ .Release.Name }}'"]
      mongodb:
        backup:
          enabled: false
    asserts:
      - contains:
          path: spec.template.spec.initContainers
          content:
            name: extra-init-container
            image: extra-init-container-image
            command: ["sh", "-c", "echo 'Hello my-release'"]
  - it: should include extra init containers from root level (as string)
    set:
      extraInitContainers: >
        - name: extra-init-container
          image: extra-init-container-image
          command: ["sh", "-c", "echo 'Hello {{ .Release.Name }}'"]
      mongodb:
        backup:
          enabled: false
    asserts:
      - contains:
          path: spec.template.spec.initContainers
          content:
            name: extra-init-container
            image: extra-init-container-image
            command: ["sh", "-c", "echo 'Hello my-release'"]
  - it: should include extra init containers from catalog level when both are defined
    set:
      extraInitContainers: >
        - name: extra-init-container-root
          image: extra-init-container-image-root
          command: [ "sh", "-c", "echo 'Hello {{ .Release.Name }}' from root" ]
      mongodb:
        backup:
          enabled: false
      catalogservices:
        extraInitContainers:
          - name: extra-init-container-catalog
            image: extra-init-container-image-catalog
            command: ["sh", "-c", "echo 'Hello {{ .Release.Name }}' from catalog"]
    asserts:
      - contains:
          path: spec.template.spec.initContainers
          content:
            name: extra-init-container-catalog
            image: extra-init-container-image-catalog
            command: ["sh", "-c", "echo 'Hello my-release' from catalog"]
      - notContains:
          path: spec.template.spec.initContainers
          content:
            name: extra-init-container
            image: extra-init-container-image
            command: ["sh", "-c", "echo 'Hello my-release' from root"]

  - it: should include extra start params from catalog level
    set:
      catalogservices:
        extraStartParams: >-
          -Dtest.release={{ .Release.Name }}
          -Dtest.namespace={{ .Release.Namespace }}
      mongodb:
        backup:
          enabled: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: JAVA_OPTS_APPEND
            value: -Dtest.release=my-release -Dtest.namespace=my-namespace
  - it: should include extra start params from root level
    set:
      extraStartParams: >-
        -Dtest.release={{ .Release.Name }}
        -Dtest.namespace={{ .Release.Namespace }}
      mongodb:
        backup:
          enabled: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: JAVA_OPTS_APPEND
            value: -Dtest.release=my-release -Dtest.namespace=my-namespace
  - it: should include extra start params from catalog level when both are defined
    set:
      extraStartParams: >-
        -Dtest.release={{ .Release.Name }}
        -Dtest.namespace={{ .Release.Namespace }}
      mongodb:
        backup:
          enabled: false
      catalogservices:
        extraStartParams: >-
          -Dtest.catalog.release={{ .Release.Name }}
          -Dtest.catalog.namespace={{ .Release.Namespace }}
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: JAVA_OPTS_APPEND
            value: -Dtest.catalog.release=my-release -Dtest.catalog.namespace=my-namespace
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: JAVA_OPTS_APPEND
            value: -Dtest.release=my-release -Dtest.namespace=my-namespace

  # PriorityClassName tests
  - it: should not include priorityClassName by default
    asserts:
      - notExists:
          path: spec.template.spec.priorityClassName
  - it: catalogservices.priorityClassName should set priorityClassName
    set:
      catalogservices:
        priorityClassName: catalog-services-priority
      mongodb:
        backup:
          enabled: false
    asserts:
      - equal:
          path: spec.template.spec.priorityClassName
          value: catalog-services-priority
  - it: should not include priorityClassName when catalogservices.priorityClassName is empty
    set:
      catalogservices:
        priorityClassName: ""
      mongodb:
        backup:
          enabled: false
    asserts:
      - notExists:
          path: spec.template.spec.priorityClassName
