#
# Copyright (C) 2017-2019 Dremio Corporation. This file is confidential and private property.
#

suite: Dremio EE Helm Chart.Coordinator Tests
templates:
  - dremio-coordinator.yaml
  - dremio-configmap.yaml
set:
  distStorage:
    type: gcp
    gcp:
      bucketName: test-bucket
      authentication: auto
      credentials:
        clientEmail: test@example.com
        privateKey: test-private-key
tests:
  - it: should not include extra environment variables by default
    template: dremio-coordinator.yaml
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEST_VARIABLE
            value: test_value
  - it: should include extra environment variables set at the root level in values.yaml
    template: dremio-coordinator.yaml
    set:
      extraEnvs:
        - name: TEST_VARIABLE_1
          value: test_value
        - name: TEST_VARIABLE_2
          value: test_value
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEST_VARIABLE_1
            value: test_value
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEST_VARIABLE_2
            value: test_value
  - it: environment variables set at coordinator.extraEnvs should take
      precedence over environment variables set at root level
    template: dremio-coordinator.yaml
    set:
      extraEnvs:
        - name: TEST_ROOT_VARIABLE_1
          value: test_value
        - name: TEST_ROOT_VARIABLE_2
          value: test_value
      coordinator:
        extraEnvs:
          - name: TEST_COORDINATOR_VARIABLE_1
            value: test_value
          - name: TEST_COORDINATOR_VARIABLE_2
            value: test_value
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            - name: TEST_ROOT_VARIABLE_1
              value: test_value
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            - name: TEST_ROOT_VARIABLE_2
              value: test_value
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEST_COORDINATOR_VARIABLE_1
            value: test_value
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEST_COORDINATOR_VARIABLE_2
            value: test_value
  - it: environment variable names cannot begin with 'DREMIO_'
    template: dremio-coordinator.yaml
    set:
      coordinator:
        extraEnvs:
          - name: DREMIO_TEST
            value: test_value
    asserts:
      - failedTemplate:
          errorMessage: "Environment variables cannot begin with DREMIO"
  - it: environment variable names can contain 'DREMIO'
    template: dremio-coordinator.yaml
    set:
      coordinator:
        extraEnvs:
          - name: TEST_DREMIO
            value: test_value
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEST_DREMIO
            value: test_value
  - it: should write logs to file by default
    template: dremio-coordinator.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "0"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
            value: /opt/dremio/log
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
            mountPath: /opt/dremio/log
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 512Gi
  - it: should write logs to file when global dremio.log.enabled is true
    template: dremio-coordinator.yaml
    set:
      dremio:
        log:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "0"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
            value: /opt/dremio/log
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
            mountPath: /opt/dremio/log

  - it: should not write logs to file when global dremio.log.enabled is false
    template: dremio-coordinator.yaml
    set:
      dremio:
        log:
          enabled: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "1"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
  - it: should not write logs to file when coordinator.log.enabled is false
    template: dremio-coordinator.yaml
    set:
      coordinator:
        log:
          enabled: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "1"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume

  - it: should write logs to file when coordinator.log.enabled is true
    template: dremio-coordinator.yaml
    set:
      dremio:
        log:
          enabled: false
      coordinator:
        log:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
            value: /opt/dremio/log
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "0"
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
            mountPath: /opt/dremio/log

  - it: should use custom log volume size when specified at coordinator level
    template: dremio-coordinator.yaml
    set:
      dremio:
        log:
          volume:
            size: 100Gi
      coordinator:
        log:
          volume:
            size: 200Gi
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 200Gi
  - it: should use default storage class when not specified
    template: dremio-coordinator.yaml
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 512Gi
      - notExists:
          path: spec.volumeClaimTemplates[?(@.metadata.name == "dremio-log-volume")].spec.storageClassName

  - it: should use global storage class for log volume
    template: dremio-coordinator.yaml
    set:
      storageClass: fast-ssd
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 512Gi
              storageClassName: fast-ssd
  - it: should use dremio logs storage class when specified
    template: dremio-coordinator.yaml
    set:
      storageClass: fast-ssd
      dremio:
        log:
          volume:
            storageClass: premium-ssd
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 512Gi
              storageClassName: premium-ssd
  - it: should use coordinator logs storage class when specified
    template: dremio-coordinator.yaml
    set:
      storageClass: fast-ssd
      dremio:
        log:
          volume:
            storageClass: premium-ssd
      coordinator:
        log:
          volume:
            storageClass: ultra-ssd
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              storageClassName: ultra-ssd
              resources:
                requests:
                  storage: 512Gi
              accessModes:
                - ReadWriteOnce
  - it: should handle different volume size formats
    template: dremio-coordinator.yaml
    set:
      coordinator:
        log:
          volume:
            size: "500Mi"
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: "500Mi"

  - it: should handle large volume sizes
    template: dremio-coordinator.yaml
    set:
      coordinator:
        log:
          volume:
            size: "1Ti"
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: "1Ti"
  - it: should not specify storage class when none is configured
    template: dremio-coordinator.yaml
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes: [ "ReadWriteOnce" ]
              resources:
                requests:
                  storage: 512Gi
      - notExists:
          path: spec.volumeClaimTemplates[?(@.metadata.name == "dremio-log-volume")].spec.storageClassName

  # Global storage class tests
  - it: should use global storage class for log volume when specified
    template: dremio-coordinator.yaml
    set:
      storageClass: fast-ssd
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 512Gi
              storageClassName: fast-ssd

  - it: should use global storage class with different values
    template: dremio-coordinator.yaml
    set:
      storageClass: premium-storage
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 512Gi
              storageClassName: premium-storage
  - it: should prioritize dremio logs storage class over global storage class
    template: dremio-coordinator.yaml
    set:
      storageClass: global-storage
      dremio:
        log:
          volume:
            storageClass: dremio-specific-storage
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 512Gi
              storageClassName: dremio-specific-storage
      - notContains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-specific-storage
  # Coordinator-level logs storage class tests
  - it: should use coordinator logs storage class when specified
    template: dremio-coordinator.yaml
    set:
      storageClass: global-storage
      dremio:
        log:
          volume:
            storageClass: dremio-logs-storage
      coordinator:
        log:
          volume:
            storageClass: coordinator-logs-storage
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 512Gi
              storageClassName: coordinator-logs-storage

  - it: should prioritize coordinator logs storage class over all other levels
    template: dremio-coordinator.yaml
    set:
      storageClass: global-storage
      dremio:
        log:
          volume:
            storageClass: dremio-logs-storage
      coordinator:
        log:
          volume:
            storageClass: coordinator-specific-storage
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 512Gi
              storageClassName: coordinator-specific-storage
      - notContains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              storageClassName: dremio-logs-storage
      - notContains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              storageClassName: global-storage

  # Storage class inheritance hierarchy tests
  - it: should fall back to dremio logs storage class when coordinator is not specified
    template: dremio-coordinator.yaml
    set:
      storageClass: global-storage
      dremio:
        log:
          volume:
            storageClass: dremio-fallback-storage
      coordinator:
        log:
          volume: { }  # Empty volume config
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 512Gi
              storageClassName: dremio-fallback-storage

  - it: should fall back to global storage class when dremio logs is not specified
    template: dremio-coordinator.yaml
    set:
      storageClass: global-fallback-storage
      dremio:
        log: { }  # Empty logs config
      coordinator:
        log:
          volume: { }  # Empty volume config
    asserts:
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: dremio-log-volume
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 512Gi
              storageClassName: global-fallback-storage

  # Null and empty value handling
  - it: should handle null storage class values correctly
    template: dremio-coordinator.yaml
    set:
      storageClass: null
      dremio:
        log:
          volume:
            storageClass: null
      coordinator:
        logs:
          volume:
            storageClass: null
    asserts:
      - notExists:
          path: spec.volumeClaimTemplates[?(@.metadata.name == "dremio-log-volume")].spec.storageClassName

  - it: should handle empty string storage class values correctly
    template: dremio-coordinator.yaml
    set:
      storageClass: ""
      dremio:
        log:
          volume:
            storageClass: ""
      coordinator:
        logs:
          volume:
            storageClass: ""
    asserts:
      - notExists:
          path: spec.volumeClaimTemplates[?(@.metadata.name == "dremio-log-volume")].spec.storageClassName
  - it: should write logs to file when global writeLogsToFile is explicitly true
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "0"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
            value: /opt/dremio/log
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
            mountPath: /opt/dremio/log

  - it: should not write logs to file when global writeLogsToFile is false
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "1"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume

  # Coordinator-specific writeLogsToFile configuration tests
  - it: should write logs to file when coordinator writeLogsToFile is true
    template: dremio-coordinator.yaml
    set:
      coordinator:
        writeLogsToFile: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "0"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
            value: /opt/dremio/log
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
            mountPath: /opt/dremio/log

  - it: should not write logs to file when coordinator writeLogsToFile is false
    template: dremio-coordinator.yaml
    set:
      coordinator:
        writeLogsToFile: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "1"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume

  # Precedence tests - coordinator overrides global
  - it: should prioritize coordinator writeLogsToFile over global setting (coordinator true, global false)
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: false
      coordinator:
        writeLogsToFile: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "0"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
            value: /opt/dremio/log
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
            mountPath: /opt/dremio/log

  - it: should prioritize coordinator writeLogsToFile over global setting (coordinator false, global true)
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: true
      coordinator:
        writeLogsToFile: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "1"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume

  # Environment variable validation tests
  - it: should set DREMIO_LOG_TO_CONSOLE to "0" when writeLogsToFile is true
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "0"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "1"

  - it: should set DREMIO_LOG_TO_CONSOLE to "1" when writeLogsToFile is false
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "1"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_TO_CONSOLE
            value: "0"

  - it: should set DREMIO_LOG_DIR when writeLogsToFile is true
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR
            value: /opt/dremio/log

  - it: should not set DREMIO_LOG_DIR when writeLogsToFile is false
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: false
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: DREMIO_LOG_DIR

  # Volume mount behavior tests
  - it: should include log volume mount when writeLogsToFile is true
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
            mountPath: /opt/dremio/log

  - it: should not include log volume mount when writeLogsToFile is false
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: false
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume

  - it: should include log volume mount when coordinator writeLogsToFile overrides global false
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: false
      coordinator:
        writeLogsToFile: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
            mountPath: /opt/dremio/log

  - it: should not include log volume mount when coordinator writeLogsToFile overrides global true
    template: dremio-coordinator.yaml
    set:
      writeLogsToFile: true
      coordinator:
        writeLogsToFile: false
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dremio-log-volume
  - it: should use default init container image
    template: dremio-coordinator.yaml
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: quay.io/dremio/busybox:1.37.0-glibc
      - equal:
          path: spec.template.spec.initContainers[0].imagePullPolicy
          value: IfNotPresent
  - it: should use custom init container image
    template: dremio-coordinator.yaml
    set:
      busyBox:
        image:
          repository: custom-image
          tag: custom-tag
          pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: custom-image:custom-tag
      - equal:
          path: spec.template.spec.initContainers[0].imagePullPolicy
          value: Always
  - it: catalogservices should be excluded when feature is disabled (JVM options excluded)
    template: dremio-coordinator.yaml
    set:
      catalogservices:
        enabled: false
    asserts:
      - notMatchRegex:
          path: spec.template.spec.containers[0].env[2].value
          pattern: dremiocatalog*
  - it: JVM options for catalogservices should be included by default
    template: dremio-coordinator.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].env[2].value
          pattern: dremiocatalog*
  - it: should use default pod security context when coordinator.podSecurityContext is not set
    template: dremio-coordinator.yaml
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 999
      - equal:
          path: spec.template.spec.securityContext.fsGroupChangePolicy
          value: OnRootMismatch
  - it: should use custom pod security context when coordinator.podSecurityContext is set
    template: dremio-coordinator.yaml
    set:
      coordinator:
        podSecurityContext:
          runAsUser: 1001
          runAsGroup: 1002
          fsGroup: 1003
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1001
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 1002
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1003
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.seccompProfile.type
          value: RuntimeDefault
  - it: should use default container security context when coordinator.containerSecurityContext is not set
    template: dremio-coordinator.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.privileged
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsGroup
          value: 999
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 999
      - equal:
          path: spec.template.spec.containers[0].securityContext.seccompProfile.type
          value: RuntimeDefault
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop[0]
          value: ALL
  - it: should use custom container security context when coordinator.containerSecurityContext is set
    template: dremio-coordinator.yaml
    set:
      coordinator:
        containerSecurityContext:
          runAsUser: 2001
          runAsGroup: 2002
          runAsNonRoot: false
          privileged: true
          allowPrivilegeEscalation: true
          readOnlyRootFilesystem: true
          capabilities:
            add:
              - SYS_ADMIN
              - NET_ADMIN
            drop:
              - CHOWN
              - SETUID
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 2001
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsGroup
          value: 2002
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.privileged
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.add[0]
          value: SYS_ADMIN
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.add[1]
          value: NET_ADMIN
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop[0]
          value: CHOWN
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop[1]
          value: SETUID
  - it: should use global pod security context when coordinator.podSecurityContext is not set but global podSecurityContext is set
    template: dremio-coordinator.yaml
    set:
      podSecurityContext:
        runAsUser: 5001
        runAsGroup: 5002
        fsGroup: 5003
        runAsNonRoot: true
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 5001
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 5002
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 5003
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
  - it: should use global container security context when coordinator.containerSecurityContext is not set but global containerSecurityContext is set
    template: dremio-coordinator.yaml
    set:
      containerSecurityContext:
        runAsUser: 6001
        runAsGroup: 6002
        runAsNonRoot: false
        privileged: true
        allowPrivilegeEscalation: true
        readOnlyRootFilesystem: true
        capabilities:
          add:
            - NET_BIND_SERVICE
          drop:
            - MKNOD
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 6001
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsGroup
          value: 6002
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.privileged
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.add[0]
          value: NET_BIND_SERVICE
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop[0]
          value: MKNOD
  - it: coordinator security context should override global security context
    template: dremio-coordinator.yaml
    set:
      podSecurityContext:
        runAsUser: 7001
        fsGroup: 7002
      containerSecurityContext:
        runAsUser: 7003
        runAsGroup: 7004
        privileged: true
      coordinator:
        podSecurityContext:
          runAsUser: 8001
          fsGroup: 8002
        containerSecurityContext:
          runAsUser: 8003
          runAsGroup: 8004
          privileged: false
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 8001
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 8002
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 8003
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsGroup
          value: 8004
      - equal:
          path: spec.template.spec.containers[0].securityContext.privileged
          value: false
  - it: should use default container security context for init containers when coordinator.containerSecurityContext is not set
    template: dremio-coordinator.yaml
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.privileged
          value: false
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.readOnlyRootFilesystem
          value: false
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsGroup
          value: 999
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsUser
          value: 999
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.seccompProfile.type
          value: RuntimeDefault
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.capabilities.drop[0]
          value: ALL
  - it: should use custom container security context for init containers when coordinator.containerSecurityContext is set
    template: dremio-coordinator.yaml
    set:
      coordinator:
        containerSecurityContext:
          runAsUser: 9001
          runAsGroup: 9002
          runAsNonRoot: false
          privileged: true
          allowPrivilegeEscalation: true
          readOnlyRootFilesystem: true
          capabilities:
            add:
              - SYS_TIME
            drop:
              - KILL
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsUser
          value: 9001
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsGroup
          value: 9002
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsNonRoot
          value: false
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.privileged
          value: true
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.allowPrivilegeEscalation
          value: true
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.capabilities.add[0]
          value: SYS_TIME
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.capabilities.drop[0]
          value: KILL
  - it: should handle empty coordinator security contexts gracefully
    template: dremio-coordinator.yaml
    set:
      coordinator:
        podSecurityContext: {}
        containerSecurityContext: {}
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 999
      - equal:
          path: spec.template.spec.securityContext.fsGroupChangePolicy
          value: OnRootMismatch
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 999

  # PriorityClassName tests
  - it: should not include priorityClassName by default
    template: dremio-coordinator.yaml
    asserts:
      - notExists:
          path: spec.template.spec.priorityClassName
  - it: coordinator.priorityClassName should set priorityClassName
    template: dremio-coordinator.yaml
    set:
      coordinator:
        priorityClassName: coordinator-high-priority
    asserts:
      - equal:
          path: spec.template.spec.priorityClassName
          value: coordinator-high-priority
  - it: should not include priorityClassName when coordinator.priorityClassName is empty
    template: dremio-coordinator.yaml
    set:
      coordinator:
        priorityClassName: ""
    asserts:
      - notExists:
          path: spec.template.spec.priorityClassName
