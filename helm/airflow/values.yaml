# Apache Airflow Helm Values Configuration
# Standalone deployment with PostgreSQL + LocalExecutor
# Integrated with Keycloak for authentication via Keycloak Auth Manager

# Executor: LocalExecutor for standalone testing
executor: "LocalExecutor"

# Disable Celery workers (not needed for LocalExecutor)
workers:
  replicas: 0

# Disable Flower (Celery monitoring)
flower:
  enabled: false

# Enable triggerer for async operations
triggerer:
  enabled: true
  replicas: 1

# PostgreSQL database configuration
postgresql:
  enabled: true

# Redis (disabled for LocalExecutor)
redis:
  enabled: false

# Web server configuration
webserver:
  replicas: 1
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  
  # Default admin user (fallback before Keycloak auth is initialized)
  defaultUser:
    enabled: true
    role: Admin
    username: admin
    email: admin@airflow.local
    firstName: Airflow
    lastName: Admin
    password: admin

# Scheduler configuration
scheduler:
  replicas: 1
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

# DAGs configuration - use persistent volume
dags:
  persistence:
    enabled: true
    size: 1Gi
    accessMode: ReadWriteOnce

# Logs configuration
logs:
  persistence:
    enabled: true
    size: 2Gi

# Extra environment variables for Keycloak Auth Manager
extraEnv: |
  - name: AIRFLOW__CORE__AUTH_MANAGER
    value: "airflow.providers.keycloak.auth_manager.keycloak_auth_manager.KeycloakAuthManager"
  - name: AIRFLOW__KEYCLOAK_AUTH_MANAGER__CLIENT_ID
    value: "airflow"
  - name: AIRFLOW__KEYCLOAK_AUTH_MANAGER__CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: airflow-keycloak-secret
        key: client-secret
  - name: AIRFLOW__KEYCLOAK_AUTH_MANAGER__REALM
    value: "vault"
  - name: AIRFLOW__KEYCLOAK_AUTH_MANAGER__SERVER_URL
    value: "http://keycloak-service.operators.svc.cluster.local:8080"
  - name: AIRFLOW__WEBSERVER__BASE_URL
    value: "http://localhost:8085"

# Ingress (disabled - using port-forward for local access)
ingress:
  web:
    enabled: false

# Enable git-sync for DAGs (optional)
gitSync:
  enabled: false

# Create default connections/pools/variables
createUserJob:
  useHelmHooks: false

migrateDatabaseJob:
  useHelmHooks: false

# Security context
securityContexts:
  pod:
    runAsUser: 50000
    fsGroup: 0
  container:
    runAsUser: 50000
