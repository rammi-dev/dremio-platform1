#
# Copyright (C) 2017-2019 Dremio Corporation. This file is confidential and private property.
#

suite: Dremio EE Helm Chart.OpenShift Roles Tests
templates:
  - openshift-roles.yaml
set:
  distStorage:
    type: gcp
    gcp:
      bucketName: test-bucket
      authentication: auto
      credentials:
        clientEmail: test@example.com
        privateKey: test-private-key
tests:
  - it: should not render when useOpenShiftRoles is false
    set:
      useOpenShiftRoles: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render all 4 RoleBindings when useOpenShiftRoles is true
    set:
      useOpenShiftRoles: true
    asserts:
      - hasDocuments:
          count: 4
      - isKind:
          of: RoleBinding
        documentIndex: 0
      - isKind:
          of: RoleBinding
        documentIndex: 1
      - isKind:
          of: RoleBinding
        documentIndex: 2
      - isKind:
          of: RoleBinding
        documentIndex: 3

  - it: should render additional RoleBindings for legacy executor engines
    set:
      useOpenShiftRoles: true
      executor:
        engines:
          - default
          - gpu
    asserts:
      - hasDocuments:
          count: 8
      - isKind:
          of: RoleBinding
        documentIndex: 4
      - isKind:
          of: RoleBinding
        documentIndex: 5
      - isKind:
          of: RoleBinding
        documentIndex: 6
      - isKind:
          of: RoleBinding
        documentIndex: 7

  - it: should have correct metadata names for all RoleBindings
    set:
      useOpenShiftRoles: true
    asserts:
      - equal:
          path: metadata.name
          value: allow-dremio-coordinator-accounts-to-use-nonroot
        documentIndex: 0
      - equal:
          path: metadata.name
          value: allow-dremio-coordinator-accounts-to-use-nonroot-v2
        documentIndex: 1
      - equal:
          path: metadata.name
          value: allow-dremio-executor-accounts-to-use-nonroot
        documentIndex: 2
      - equal:
          path: metadata.name
          value: allow-dremio-executor-accounts-to-use-nonroot-v2
        documentIndex: 3

  - it: should have correct metadata names for legacy executor engines
    set:
      useOpenShiftRoles: true
      executor:
        engines:
          - default
          - gpu
    asserts:
      - equal:
          path: metadata.name
          value: allow-dremio-engine-default-use-nonroot
        documentIndex: 4
      - equal:
          path: metadata.name
          value: allow-dremio-engine-default-to-use-nonroot-v2
        documentIndex: 5
      - equal:
          path: metadata.name
          value: allow-dremio-engine-gpu-use-nonroot
        documentIndex: 6
      - equal:
          path: metadata.name
          value: allow-dremio-engine-gpu-to-use-nonroot-v2
        documentIndex: 7

  - it: should use default coordinator service account
    set:
      useOpenShiftRoles: true
    asserts:
      - equal:
          path: subjects[0].name
          value: dremio-coordinator
        documentIndex: 0
      - equal:
          path: subjects[0].name
          value: dremio-coordinator
        documentIndex: 1

  - it: should use custom coordinator service account when specified
    set:
      useOpenShiftRoles: true
      coordinator:
        serviceAccount: custom-coordinator
    asserts:
      - equal:
          path: subjects[0].name
          value: custom-coordinator
        documentIndex: 0
      - equal:
          path: subjects[0].name
          value: custom-coordinator
        documentIndex: 1

  - it: should use default executor service account
    set:
      useOpenShiftRoles: true
    asserts:
      - equal:
          path: subjects[0].name
          value: dremio-engine-executor
        documentIndex: 2
      - equal:
          path: subjects[0].name
          value: dremio-engine-executor
        documentIndex: 3

  - it: should use custom executor service account when specified
    set:
      useOpenShiftRoles: true
      engine:
        executor:
          serviceAccount: custom-executor
    asserts:
      - equal:
          path: subjects[0].name
          value: custom-executor
        documentIndex: 2
      - equal:
          path: subjects[0].name
          value: custom-executor
        documentIndex: 3

  - it: should use default service accounts for legacy executor engines
    set:
      useOpenShiftRoles: true
      executor:
        engines:
          - default
          - gpu
    asserts:
      - equal:
          path: subjects[0].name
          value: dremio-executor
        documentIndex: 4
      - equal:
          path: subjects[0].name
          value: dremio-executor
        documentIndex: 5
      - equal:
          path: subjects[0].name
          value: dremio-executor
        documentIndex: 6
      - equal:
          path: subjects[0].name
          value: dremio-executor
        documentIndex: 7

  - it: should use custom service accounts for legacy executor engines when specified
    set:
      useOpenShiftRoles: true
      executor:
        engines:
          - default
          - gpu
        engineOverride:
          gpu:
            serviceAccount: custom-gpu-executor
    asserts:
      - equal:
          path: subjects[0].name
          value: dremio-executor
        documentIndex: 4
      - equal:
          path: subjects[0].name
          value: dremio-executor
        documentIndex: 5
      - equal:
          path: subjects[0].name
          value: custom-gpu-executor
        documentIndex: 6
      - equal:
          path: subjects[0].name
          value: custom-gpu-executor
        documentIndex: 7

  - it: should reference correct ClusterRoles for coordinator
    set:
      useOpenShiftRoles: true
    asserts:
      - equal:
          path: roleRef.name
          value: system:openshift:scc:nonroot
        documentIndex: 0
      - equal:
          path: roleRef.name
          value: system:openshift:scc:nonroot-v2
        documentIndex: 1

  - it: should reference correct ClusterRoles for executor
    set:
      useOpenShiftRoles: true
    asserts:
      - equal:
          path: roleRef.name
          value: system:openshift:scc:nonroot-v2
        documentIndex: 2
      - equal:
          path: roleRef.name
          value: system:openshift:scc:nonroot-v2
        documentIndex: 3

  - it: should reference correct ClusterRoles for legacy executor engines
    set:
      useOpenShiftRoles: true
      executor:
        engines:
          - default
          - gpu
    asserts:
      - equal:
          path: roleRef.name
          value: system:openshift:scc:nonroot-v2
        documentIndex: 4
      - equal:
          path: roleRef.name
          value: system:openshift:scc:nonroot-v2
        documentIndex: 5
      - equal:
          path: roleRef.name
          value: system:openshift:scc:nonroot-v2
        documentIndex: 6
      - equal:
          path: roleRef.name
          value: system:openshift:scc:nonroot-v2
        documentIndex: 7

  - it: should have correct roleRef properties for all RoleBindings
    set:
      useOpenShiftRoles: true
    asserts:
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io
        documentIndex: 0
      - equal:
          path: roleRef.kind
          value: ClusterRole
        documentIndex: 0
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io
        documentIndex: 1
      - equal:
          path: roleRef.kind
          value: ClusterRole
        documentIndex: 1
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io
        documentIndex: 2
      - equal:
          path: roleRef.kind
          value: ClusterRole
        documentIndex: 2
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io
        documentIndex: 3
      - equal:
          path: roleRef.kind
          value: ClusterRole
        documentIndex: 3

  - it: should have correct subject properties for all RoleBindings
    release:
      name: test-release
      namespace: test-namespace
    set:
      useOpenShiftRoles: true
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 0
      - equal:
          path: subjects[0].namespace
          value: test-namespace
        documentIndex: 0
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 1
      - equal:
          path: subjects[0].namespace
          value: test-namespace
        documentIndex: 1
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 2
      - equal:
          path: subjects[0].namespace
          value: test-namespace
        documentIndex: 2
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 3
      - equal:
          path: subjects[0].namespace
          value: test-namespace
        documentIndex: 3

  - it: should have correct subject properties for legacy executor engines
    release:
      name: test-release
      namespace: test-namespace
    set:
      useOpenShiftRoles: true
      executor:
        engines:
          - default
          - gpu
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 4
      - equal:
          path: subjects[0].namespace
          value: test-namespace
        documentIndex: 4
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 5
      - equal:
          path: subjects[0].namespace
          value: test-namespace
        documentIndex: 5
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 6
      - equal:
          path: subjects[0].namespace
          value: test-namespace
        documentIndex: 6
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 7
      - equal:
          path: subjects[0].namespace
          value: test-namespace
        documentIndex: 7

  - it: should handle empty executor engines list
    set:
      useOpenShiftRoles: true
      executor:
        engines: []
    asserts:
      - hasDocuments:
          count: 4

  - it: should handle single legacy executor engine
    set:
      useOpenShiftRoles: true
      executor:
        engines:
          - special
    asserts:
      - hasDocuments:
          count: 6
      - equal:
          path: metadata.name
          value: allow-dremio-engine-special-use-nonroot
        documentIndex: 4
      - equal:
          path: metadata.name
          value: allow-dremio-engine-special-to-use-nonroot-v2
        documentIndex: 5
