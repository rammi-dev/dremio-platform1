#
# Copyright (C) 2017-2019 Dremio Corporation. This file is confidential and private property.
#

suite: Dremio EE Helm Chart.OpenSearch Aux Service Account Tests
templates:
  - opensearch.yaml
set:
  distStorage:
    type: gcp
    gcp:
      bucketName: test-bucket
      authentication: auto
      credentials:
        clientEmail: test@example.com
        privateKey: test-private-key
tests:
  - it: should not include imagePullSecrets by default
    documentIndex: 1
    asserts:
      - notExists:
          path: imagePullSecrets
  - it: should include imagePullSecrets
    documentIndex: 1
    set:
      imagePullSecrets:
        - test-0
        - test-1
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: test-0
      - equal:
          path: imagePullSecrets[1].name
          value: test-1
  - it: should include trial secret name in pull secrets if dremio.trialImagePullCredentials is set
    documentIndex: 1
    set:
      dremio.trialImagePullCredentials: test-credentials
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: dremio-trial-image-pull-credentials
  - it: should include imagePullSecrets in addition to the trial secret name in pull secrets
    documentIndex: 1
    set:
      imagePullSecrets:
        - test-0
        - test-1
      dremio.trialImagePullCredentials: test-credentials
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: test-0
      - equal:
          path: imagePullSecrets[1].name
          value: test-1
      - equal:
          path: imagePullSecrets[2].name
          value: dremio-trial-image-pull-credentials
  - it: should have required helm hook annotations by default
    documentIndex: 1
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: before-hook-creation
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "-10"
  - it: should include serviceAccountAnnotations when configured
    documentIndex: 1
    set:
      opensearch:
        preInstallJob:
          serviceAccountAnnotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
            example.com/custom-annotation: "custom-value"
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: before-hook-creation
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "-10"
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"
      - equal:
          path: metadata.annotations["example.com/custom-annotation"]
          value: "custom-value"
  - it: should include single serviceAccountAnnotation when configured
    documentIndex: 1
    set:
      opensearch:
        preInstallJob:
          serviceAccountAnnotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"
  - it: should only have helm hook annotations when serviceAccountAnnotations is empty
    documentIndex: 1
    set:
      opensearch:
        preInstallJob:
          serviceAccountAnnotations: {}
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install,pre-upgrade
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: before-hook-creation
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "-10"
      - notExists:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
  - it: should use correct service account name
    documentIndex: 1
    asserts:
      - equal:
          path: metadata.name
          value: dremio-opensearch-aux
  - it: should be a ServiceAccount
    documentIndex: 1
    asserts:
      - isKind:
          of: ServiceAccount
